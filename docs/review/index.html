<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>ç”»é¢ãƒ¬ãƒ“ãƒ¥ãƒ¼è³‡æ–™ â€” Machining System v3.1</title>
<style>
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:#f1f5f9;color:#1e293b;display:flex;min-height:100vh;}
#sidebar{width:240px;min-height:100vh;background:#0f172a;position:fixed;top:0;left:0;overflow-y:auto;z-index:100;}
#main-content{margin-left:240px;flex:1;min-height:100vh;}
.page{display:none;padding:32px 36px;}
.page.active{display:block;}
#dashboard{padding:32px 36px;}
.nav-group{padding:6px 16px;font-size:10px;font-weight:700;color:#475569;text-transform:uppercase;letter-spacing:1px;margin-top:8px;}
.nav-item{padding:8px 16px;font-size:12px;color:#94a3b8;cursor:pointer;display:flex;align-items:center;gap:8px;transition:all .15s;}
.nav-item:hover,.nav-item.active{background:#1e293b;color:#f1f5f9;}
.nav-sub{padding:5px 16px 5px 32px;font-size:11px;color:#64748b;}
.nav-sub:hover{background:#1e293b;color:#94a3b8;}
.card{background:white;border-radius:12px;padding:20px 24px;box-shadow:0 1px 3px rgba(0,0,0,.08);margin-bottom:16px;}
.card-title{font-size:13px;font-weight:700;color:#64748b;text-transform:uppercase;letter-spacing:.5px;margin-bottom:14px;padding-bottom:10px;border-bottom:1px solid #f1f5f9;}
.stat-card{background:white;border-radius:12px;padding:20px 24px;box-shadow:0 1px 3px rgba(0,0,0,.08);}
.stat-label{font-size:12px;color:#94a3b8;font-weight:600;margin-bottom:6px;}
.stat-num{font-size:32px;font-weight:700;line-height:1;}
.badge{display:inline-block;padding:4px 10px;border-radius:6px;font-size:12px;font-weight:600;}
.badge-ok{background:#f0fdf4;color:#16a34a;border:1px solid #bbf7d0;}
.badge-ng{background:#fff5f5;color:#dc2626;border:1px solid #fecaca;}
.badge-warn{background:#fff7ed;color:#c2410c;border:1px solid #fed7aa;}
.mono{font-family:'JetBrains Mono','Fira Code',monospace;}
.spec-table{width:100%;border-collapse:collapse;font-size:13px;}
.spec-table th{background:#f8fafc;padding:8px 12px;text-align:left;font-weight:600;color:#64748b;border-bottom:2px solid #e2e8f0;}
.spec-table td{padding:8px 12px;border-bottom:1px solid #f1f5f9;}
.spec-table tr:hover td{background:#f8fafc;}
.action-log{border-radius:10px;border:1px solid #e2e8f0;margin-bottom:16px;overflow:hidden;}
.action-log.is-ng{border-color:#fecaca;background:#fffafa;}
.al-header{display:flex;background:#f8fafc;border-bottom:1px solid #e2e8f0;}
.al-header-cell{padding:10px 16px;border-right:1px solid #e2e8f0;}
.al-header-cell:last-child{border-right:none;}
.al-fieldlabel{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:#94a3b8;margin-bottom:3px;}
.al-fieldvalue{font-size:13px;font-weight:600;color:#0f172a;}
.al-meta{display:flex;gap:16px;padding:6px 16px;background:#fafafa;border-bottom:1px solid #f1f5f9;}
.al-meta-cell{display:flex;gap:6px;align-items:center;}
.al-ss{padding:16px;}
.al-detail{padding:0 16px 16px;}
.al-row{display:flex;padding:8px 0;border-bottom:1px solid #f8fafc;align-items:flex-start;}
.al-row:last-child{border-bottom:none;}
.al-label{width:80px;font-size:11px;font-weight:700;color:#94a3b8;padding-top:2px;flex-shrink:0;}
.al-value{flex:1;font-size:13px;color:#334155;}
.verdict-btn{display:inline-flex;align-items:center;gap:8px;border:none;background:none;cursor:pointer;padding:4px 10px;border-radius:8px;}
.verdict-btn:hover{background:#f1f5f9;}
.toggle{width:36px;height:20px;border-radius:10px;position:relative;}
.toggle-on{background:#16a34a;}
.toggle-off{background:#ef4444;}
.toggle::after{content:'';position:absolute;width:14px;height:14px;background:white;border-radius:50%;top:3px;}
.toggle-on::after{left:19px;}
.toggle-off::after{left:3px;}
.verdict-text-ok{font-size:14px;font-weight:700;color:#16a34a;}
.verdict-text-ng{font-size:14px;font-weight:700;color:#ef4444;}
.issue-note-bug{background:#fff5f5;border:1px solid #fecaca;border-radius:6px;padding:8px 12px;margin-bottom:6px;font-size:12px;color:#991b1b;}
.issue-note-spec{background:#eff6ff;border:1px solid #bfdbfe;border-radius:6px;padding:8px 12px;margin-bottom:6px;font-size:12px;color:#1e40af;}
.issue-form{display:none;margin-top:10px;background:#fff5f5;border:1px solid #fecaca;border-radius:8px;padding:14px;}
.issue-form.open{display:block;}
.issue-form-row{display:flex;align-items:center;gap:8px;margin-bottom:10px;flex-wrap:wrap;}
.issue-form-row:last-child{margin-bottom:0;}
.iff-label{font-size:11px;font-weight:700;color:#64748b;white-space:nowrap;}
.iff-select{font-size:12px;border:1px solid #cbd5e1;border-radius:6px;padding:4px 8px;background:white;}
.iff-textarea{flex:1;min-width:0;font-size:13px;border:1px solid #cbd5e1;border-radius:6px;padding:6px 10px;resize:vertical;}
.iff-input{flex:1;min-width:0;font-size:12px;border:1px solid #cbd5e1;border-radius:6px;padding:5px 10px;}
.cl-block{border:1px solid #e2e8f0;border-radius:8px;overflow:hidden;}
.cl-header{padding:7px 12px;background:#f8fafc;cursor:pointer;display:flex;align-items:center;gap:8px;font-size:12px;font-weight:700;color:#475569;user-select:none;}
.cl-header:hover{background:#f1f5f9;}
.cl-body{padding:8px;background:#1e293b;max-height:260px;overflow-y:auto;}
.cl-empty{padding:7px 12px;font-size:12px;color:#94a3b8;background:#f8fafc;border-radius:8px;}
.cl-entry{display:flex;gap:8px;align-items:flex-start;padding:4px 6px;border-radius:5px;margin-bottom:3px;font-family:monospace;font-size:11px;}
.cl-log{background:rgba(255,255,255,.04);}
.cl-info{background:rgba(59,130,246,.1);}
.cl-warn{background:rgba(251,191,36,.12);}
.cl-error{background:rgba(239,68,68,.15);}
.cl-debug{background:rgba(148,163,184,.08);}
.cl-badge{padding:1px 5px;border-radius:3px;font-size:9px;font-weight:700;flex-shrink:0;margin-top:1px;}
.cl-badge-log{background:#334155;color:#94a3b8;}
.cl-badge-info{background:#1d4ed8;color:white;}
.cl-badge-warn{background:#92400e;color:#fef9c3;}
.cl-badge-error{background:#991b1b;color:#fee2e2;}
.cl-badge-debug{background:#374151;color:#9ca3af;}
.cl-time{color:#475569;font-size:10px;flex-shrink:0;margin-top:1px;}
.cl-msg{color:#e2e8f0;word-break:break-all;flex:1;}
.cl-stack{margin-top:4px;padding:4px 8px;background:rgba(0,0,0,.3);border-radius:4px;font-size:10px;color:#94a3b8;width:100%;word-break:break-all;}
.flow-canvas{padding:16px 24px 24px;background:#f8fafc;border-radius:10px;border:1px solid #e2e8f0;margin-bottom:24px;}
.flow-row{display:flex;align-items:center;gap:0;flex-wrap:nowrap;}
.flow-row.rtl{flex-direction:row-reverse;}
.flow-row.rtl .flow-arrow-line::after{right:auto;left:-1px;border-left:none;border-right-color:#94a3b8;}
.flow-uturn{display:flex;align-items:center;height:32px;margin:0 4px;}
.flow-uturn.uturn-right{justify-content:flex-end;padding-right:28px;}
.flow-uturn.uturn-left{justify-content:flex-start;padding-left:28px;}
.flow-uturn-line{width:36px;height:32px;border:2px dashed #94a3b8;border-top:none;}
.flow-uturn.uturn-right .flow-uturn-line{border-radius:0 0 10px 0;border-left:none;}
.flow-uturn.uturn-left .flow-uturn-line{border-radius:0 0 0 10px;border-right:none;}
.flow-box{border:2px solid #3b82f6;border-radius:10px;padding:10px 14px;background:white;cursor:pointer;text-align:center;min-width:100px;max-width:130px;}
.flow-box:hover{box-shadow:0 4px 12px rgba(59,130,246,.3);}
.flow-box.start{border-color:#16a34a;background:#f0fdf4;}
.flow-box.end{border-color:#ef4444;background:#fff5f5;}
.flow-seq{font-size:10px;color:#94a3b8;font-weight:700;margin-bottom:3px;}
.flow-screen{font-size:10px;font-weight:700;color:#334155;margin-bottom:2px;}
.flow-label{font-size:11px;color:#64748b;word-break:break-all;}
.flow-arrow{display:flex;align-items:center;}
.thumb-grid{display:flex;flex-wrap:wrap;gap:12px;}
.thumb-card{border:1px solid #e2e8f0;border-radius:10px;overflow:hidden;cursor:pointer;width:160px;}
.thumb-card:hover{box-shadow:0 4px 12px rgba(0,0,0,.1);}
.thumb-card.is-ng{border-color:#fecaca;background:#fffafa;}
.thumb-img-area{position:relative;}
.thumb-seq-badge{position:absolute;top:6px;left:6px;background:rgba(0,0,0,.6);color:white;border-radius:5px;padding:1px 7px;font-size:10px;font-weight:700;z-index:1;}
.thumb-info{padding:8px 10px;}
.thumb-screen-id{font-size:10px;color:#94a3b8;margin-bottom:2px;}
.thumb-title{font-size:12px;font-weight:600;color:#334155;margin-bottom:3px;}
.thumb-action{font-size:11px;color:#64748b;}
.ss-modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:200;align-items:center;justify-content:center;}
.ss-modal-inner{background:white;border-radius:14px;max-width:900px;width:100%;max-height:90vh;overflow-y:auto;padding:24px;position:relative;}
.ss-modal-close{position:absolute;top:14px;right:16px;font-size:20px;cursor:pointer;color:#94a3b8;background:none;border:none;}
.tl-card:hover{box-shadow:0 4px 12px rgba(0,0,0,.12)!important;}
</style>
</head>
<body>

<nav id="sidebar">
  <div style="padding:20px 16px 14px;border-bottom:1px solid #1e293b;">
    <div style="font-size:15px;font-weight:700;color:#f1f5f9;">ğŸ“‹ ç”»é¢ãƒ¬ãƒ“ãƒ¥ãƒ¼è³‡æ–™</div>
    <div style="font-size:11px;color:#475569;margin-top:3px;" id="sidebar-date"></div>
  </div>
  <div style="padding:10px 0 4px;">
    <div class="nav-item active" onclick="showPage('dashboard')">ğŸ  ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</div>
  </div>
  <div class="nav-group">ä½œæ¥­ç®¡ç†</div>
  <div class="nav-item" onclick="showPage('timeline')">ğŸ“Š ä½œæ¥­ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³</div>
  <div class="nav-item" onclick="showPage('patterns')">ğŸ“Œ ä½œæ¥­ãƒ‘ã‚¿ãƒ¼ãƒ³</div>
  <div class="nav-group">ç”»é¢ä¸€è¦§ï¼ˆ0ç”»é¢ï¼‰</div>
  
  <div class="nav-group" style="margin-top:8px;">ç®¡ç†</div>
  <div class="nav-item" onclick="showPage('issues')">ğŸ› èª²é¡Œä¸€è¦§</div>
</nav>
<div id="main-content">

<div id="dashboard">
  <div style="margin-bottom:24px;">
    <h1 style="font-size:22px;font-weight:700;color:#0f172a;">ãƒ¬ãƒ“ãƒ¥ãƒ¼é€²æ—ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
    <p style="font-size:13px;color:#64748b;margin-top:4px;" id="dash-date"></p>
  </div>
  <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:24px;">
    <div class="stat-card"><div class="stat-label">ç·ç”»é¢æ•°</div>
      <div class="stat-num" style="color:#0f172a;">0</div></div>
    <div class="stat-card"><div class="stat-label">ç¢ºèªæ¸ˆ</div>
      <div class="stat-num" style="color:#16a34a;" id="db-ok">0</div></div>
    <div class="stat-card"><div class="stat-label">èª²é¡Œã‚ã‚Š</div>
      <div class="stat-num" style="color:#dc2626;" id="db-ng">0</div></div>
    <div class="stat-card"><div class="stat-label">æœªç¢ºèª</div>
      <div class="stat-num" style="color:#94a3b8;" id="db-pend">0</div></div>
  </div>
  <div class="card">
    <div class="card-title">ç”»é¢ä¸€è¦§</div>
    <table class="spec-table">
      <thead><tr><th>screenId</th><th>ç”»é¢å</th><th>çŠ¶æ…‹</th><th>èª²é¡Œæ•°</th><th>ãƒ­ã‚°</th><th>é·ç§»å›³</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</div>



<div id="timeline" class="page" style="display:none;">
  <div style="margin-bottom:20px;">
    <h1 style="font-size:21px;font-weight:700;color:#0f172a;">ğŸ“Š ä½œæ¥­ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³</h1>
    <p style="font-size:13px;color:#64748b;margin-top:4px;">å…¨ç”»é¢æ¨ªæ–­ã®æ™‚ç³»åˆ—è¡¨ç¤º â€” ã‚¯ãƒªãƒƒã‚¯ã§é¸æŠã€Shiftã‚¯ãƒªãƒƒã‚¯ã§ç¯„å›²é¸æŠ</p>
  </div>
  <div class="card" style="margin-bottom:16px;padding:14px 18px;">
    <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;">
      <span style="font-size:12px;font-weight:700;color:#64748b;">ç”»é¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼:</span>
      <button onclick="tlFilterAll()" id="tlf-all"
        style="font-size:11px;padding:3px 10px;border-radius:6px;border:1px solid #3b82f6;background:#eff6ff;color:#1d4ed8;cursor:pointer;">
        ã™ã¹ã¦è¡¨ç¤º
      </button>
      <div id="tl-filter-btns" style="display:flex;gap:6px;flex-wrap:wrap;"></div>
      <span style="margin-left:auto;font-size:12px;color:#64748b;" id="tl-total-label"></span>
    </div>
  </div>
  <div class="card" style="padding:0;overflow:hidden;">
    <div id="tl-container" style="padding:20px;background:#f8fafc;">
      <div id="tl-serpentine"></div>
    </div>
  </div>
  <div id="tl-selection-panel" style="display:none;margin-top:16px;">
    <div class="card" style="border:2px solid #3b82f6;background:#eff6ff;">
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:14px;flex-wrap:wrap;">
        <div style="font-size:14px;font-weight:700;color:#1d4ed8;">ğŸ“Œ é¸æŠä¸­: <span id="tl-sel-count">0</span> seq</div>
        <div id="tl-sel-summary" style="font-size:12px;color:#475569;flex:1;"></div>
        <button onclick="clearTlSelection()"
          style="font-size:11px;padding:4px 10px;border-radius:6px;border:1px solid #94a3b8;background:white;cursor:pointer;">é¸æŠè§£é™¤</button>
        <button onclick="openPatternModal()"
          style="font-size:12px;font-weight:700;padding:6px 16px;border-radius:8px;border:none;background:#3b82f6;color:white;cursor:pointer;">
          ğŸ“Œ ä½œæ¥­ãƒ‘ã‚¿ãƒ¼ãƒ³ã¨ã—ã¦ç™»éŒ²
        </button>
      </div>
      <div id="tl-sel-list" style="display:flex;gap:8px;flex-wrap:wrap;"></div>
    </div>
  </div>
</div>

<div id="patterns" class="page" style="display:none;">
  <div style="margin-bottom:20px;">
    <div style="display:flex;align-items:center;gap:12px;">
      <h1 style="font-size:21px;font-weight:700;color:#0f172a;">ğŸ“Œ ä½œæ¥­ãƒ‘ã‚¿ãƒ¼ãƒ³</h1>
      <button onclick="openPatternModal()"
        style="font-size:12px;font-weight:700;padding:6px 16px;border-radius:8px;border:none;background:#3b82f6;color:white;cursor:pointer;margin-left:auto;">
        ï¼‹ æ–°è¦ãƒ‘ã‚¿ãƒ¼ãƒ³ç™»éŒ²
      </button>
    </div>
  </div>
  <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:20px;">
    <div class="stat-card"><div class="stat-label">ãƒ‘ã‚¿ãƒ¼ãƒ³æ•°</div><div class="stat-num" style="color:#0f172a;" id="wpt-total">0</div></div>
    <div class="stat-card"><div class="stat-label">OK</div><div class="stat-num" style="color:#16a34a;" id="wpt-ok">0</div></div>
    <div class="stat-card"><div class="stat-label">NG</div><div class="stat-num" style="color:#dc2626;" id="wpt-ng">0</div></div>
    <div class="stat-card"><div class="stat-label">æœªè©•ä¾¡</div><div class="stat-num" style="color:#94a3b8;" id="wpt-pend">0</div></div>
  </div>
  <div id="pattern-list-area">
    <div class="card" style="color:#94a3b8;padding:32px;text-align:center;">
      ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã§seqã‚’é¸æŠã—ã€Œä½œæ¥­ãƒ‘ã‚¿ãƒ¼ãƒ³ã¨ã—ã¦ç™»éŒ²ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚
    </div>
  </div>
</div>

<!-- ä½œæ¥­ãƒ‘ã‚¿ãƒ¼ãƒ³ç™»éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="wpt-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:1000;align-items:center;justify-content:center;">
  <div style="background:white;border-radius:16px;max-width:600px;width:90%;padding:28px;max-height:90vh;overflow-y:auto;position:relative;">
    <h2 style="font-size:18px;font-weight:700;color:#0f172a;margin-bottom:20px;">ğŸ“Œ ä½œæ¥­ãƒ‘ã‚¿ãƒ¼ãƒ³ç™»éŒ²</h2>
    <div style="margin-bottom:14px;">
      <label style="font-size:12px;font-weight:700;color:#64748b;display:block;margin-bottom:5px;">ãƒ‘ã‚¿ãƒ¼ãƒ³å <span style="color:#dc2626;">*</span></label>
      <input id="wpt-name" type="text" placeholder="ä¾‹: åˆæœŸè¡¨ç¤ºã€åŠ å·¥IDåˆ‡ã‚Šæ›¿ãˆ"
        style="width:100%;border:1px solid #cbd5e1;border-radius:8px;padding:8px 12px;font-size:14px;box-sizing:border-box;">
    </div>
    <div style="margin-bottom:14px;">
      <label style="font-size:12px;font-weight:700;color:#64748b;display:block;margin-bottom:5px;">èª¬æ˜</label>
      <textarea id="wpt-desc" rows="3" placeholder="ã“ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã®æ“ä½œå†…å®¹ãƒ»ç›®çš„"
        style="width:100%;border:1px solid #cbd5e1;border-radius:8px;padding:8px 12px;font-size:13px;box-sizing:border-box;resize:vertical;"></textarea>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:14px;">
      <div>
        <label style="font-size:12px;font-weight:700;color:#64748b;display:block;margin-bottom:5px;">ç”»é¢ãƒ¢ãƒ¼ãƒ‰</label>
        <select id="wpt-mode" style="width:100%;border:1px solid #cbd5e1;border-radius:8px;padding:8px 12px;font-size:13px;">
          <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
          <option value="é–²è¦§">é–²è¦§</option><option value="ç·¨é›†">ç·¨é›†</option>
          <option value="æ–°è¦">æ–°è¦</option><option value="æ··åœ¨">æ··åœ¨ï¼ˆè¤‡æ•°ç”»é¢ï¼‰</option><option value="ãã®ä»–">ãã®ä»–</option>
        </select>
      </div>
      <div>
        <label style="font-size:12px;font-weight:700;color:#64748b;display:block;margin-bottom:5px;">å…¨ä½“è©•ä¾¡</label>
        <select id="wpt-status" onchange="toggleNgArea()"
          style="width:100%;border:1px solid #cbd5e1;border-radius:8px;padding:8px 12px;font-size:13px;">
          <option value="æœªè©•ä¾¡">â¬œ æœªè©•ä¾¡</option><option value="OK">âœ… OK</option><option value="NG">âŒ NG</option>
        </select>
      </div>
    </div>
    <div id="wpt-ng-area" style="display:none;margin-bottom:14px;">
      <label style="font-size:12px;font-weight:700;color:#64748b;display:block;margin-bottom:5px;">NGå†…å®¹ <span style="color:#dc2626;">*</span></label>
      <textarea id="wpt-ng-content" rows="3" placeholder="NG ã®å†…å®¹ãƒ»å•é¡Œç‚¹"
        style="width:100%;border:1px solid #fecaca;border-radius:8px;padding:8px 12px;font-size:13px;box-sizing:border-box;resize:vertical;background:#fff5f5;"></textarea>
      <div style="margin-top:8px;">
        <label style="font-size:12px;font-weight:700;color:#64748b;display:block;margin-bottom:5px;">å„ªå…ˆåº¦</label>
        <select id="wpt-ng-priority" style="width:100%;border:1px solid #fecaca;border-radius:8px;padding:8px 12px;font-size:13px;background:#fff5f5;">
          <option value="é«˜">ğŸ”´ é«˜</option><option value="ä¸­">ğŸŸ¡ ä¸­</option><option value="ä½">ğŸŸ¢ ä½</option>
        </select>
      </div>
    </div>
    <div style="background:#f8fafc;border-radius:8px;padding:12px;margin-bottom:20px;">
      <div style="font-size:12px;font-weight:700;color:#64748b;margin-bottom:8px;">å¯¾è±¡seqï¼ˆ<span id="wpt-modal-seqcnt">0</span>ä»¶ï¼‰</div>
      <div id="wpt-modal-seqlist" style="display:flex;gap:6px;flex-wrap:wrap;max-height:120px;overflow-y:auto;"></div>
    </div>
    <div style="display:flex;gap:10px;justify-content:flex-end;">
      <button onclick="closePatternModal()"
        style="padding:8px 20px;border-radius:8px;border:1px solid #cbd5e1;background:white;cursor:pointer;font-size:13px;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button onclick="savePattern()"
        style="padding:8px 20px;border-radius:8px;border:none;background:#3b82f6;color:white;cursor:pointer;font-size:13px;font-weight:700;">ğŸ’¾ ä¿å­˜</button>
    </div>
  </div>
</div>

<div id="issues" class="page">
  <div style="margin-bottom:22px;">
    <h1 style="font-size:21px;font-weight:700;color:#0f172a;">ğŸ› èª²é¡Œä¸€è¦§</h1>
  </div>
  <div style="display:flex;gap:10px;margin-bottom:16px;flex-wrap:wrap;">
    <select id="iss-filter-type" onchange="renderIssueTable()" style="border:1px solid #e2e8f0;border-radius:8px;padding:6px 12px;font-size:12px;">
      <option value="">ç¨®åˆ¥: ã™ã¹ã¦</option><option value="ä¸å…·åˆ">ğŸ› ä¸å…·åˆ</option>
      <option value="ä»•æ§˜é•ã„">ğŸ“ ä»•æ§˜é•ã„</option><option value="æ”¹å–„ææ¡ˆ">ğŸ’¡ æ”¹å–„ææ¡ˆ</option>
    </select>
    <select id="iss-filter-status" onchange="renderIssueTable()" style="border:1px solid #e2e8f0;border-radius:8px;padding:6px 12px;font-size:12px;">
      <option value="">çŠ¶æ…‹: ã™ã¹ã¦</option><option value="æœªå¯¾å¿œ">â¸ æœªå¯¾å¿œ</option>
      <option value="å¯¾å¿œä¸­">ğŸ”„ å¯¾å¿œä¸­</option><option value="å¯¾å¿œæ¸ˆ">âœ… å¯¾å¿œæ¸ˆ</option>
    </select>
    <select id="iss-filter-prio" onchange="renderIssueTable()" style="border:1px solid #e2e8f0;border-radius:8px;padding:6px 12px;font-size:12px;">
      <option value="">å„ªå…ˆåº¦: ã™ã¹ã¦</option><option value="é«˜">ğŸ”´ é«˜</option>
      <option value="ä¸­">ğŸŸ¡ ä¸­</option><option value="ä½">ğŸŸ¢ ä½</option>
    </select>
    <span style="margin-left:auto;align-self:center;font-size:12px;color:#64748b;" id="iss-count-lbl"></span>
  </div>
  <div id="iss-table-area"><div class="card" style="color:#94a3b8;text-align:center;padding:32px;">ç¢ºèªä¸­...</div></div>
</div>
</div>
<!-- ã‚¹ã‚¯ã‚·ãƒ§ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="ss-modal" class="ss-modal" onclick="closeModal(event)">
  <div class="ss-modal-inner">
    <button class="ss-modal-close" onclick="document.getElementById('ss-modal').style.display='none'">âœ•</button>
    <div id="modal-title" style="font-size:16px;font-weight:700;color:#0f172a;margin-bottom:12px;"></div>
    <div id="modal-ss" style="border-radius:8px;overflow:hidden;border:1px solid #e2e8f0;background:#f8fafc;min-height:200px;display:flex;align-items:center;justify-content:center;"></div>
  </div>
</div>
<script>
// =========================================================
// ç”»é¢ãƒ¬ãƒ“ãƒ¥ãƒ¼ v3.1 ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–åˆ¶å¾¡
// =========================================================

// â”€â”€ ãƒ‡ãƒ¼ã‚¿ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var META     = {};
var FIDS     = [];
var TL_DATA  = [];
var TL_COLORS= {};
var LSP      = "rev31_";

// ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³çŠ¶æ…‹
var tlSelected = [];
var tlLastIdx  = -1;
var tlVisible  = null;

// â”€â”€ localStorage â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function lsg(k){try{return JSON.parse(localStorage.getItem(LSP+k))||{};}catch(e){return {};}}
function lss(k,d){try{localStorage.setItem(LSP+k,JSON.stringify(d));}catch(e){}}

// â”€â”€ åˆæœŸåŒ– â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener("DOMContentLoaded",function(){
  var today=new Date().toLocaleDateString("ja-JP",{year:"numeric",month:"2-digit",day:"2-digit"});
  var s1=document.getElementById("sidebar-date"); if(s1) s1.textContent=today+" æ›´æ–°";
  var s2=document.getElementById("dash-date"); if(s2) s2.textContent=today+" æ™‚ç‚¹";
  Object.keys(META).forEach(function(k){ restoreVerdict(k); });
  updateDashboard();
  showPage("dashboard");
});

// â”€â”€ ãƒšãƒ¼ã‚¸åˆ‡æ›¿ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showPage(id){
  document.querySelectorAll(".page").forEach(function(p){ p.style.display="none"; p.classList.remove("active"); });
  var el=document.getElementById(id);
  if(el){ el.style.display="block"; el.classList.add("active"); }
  document.querySelectorAll(".nav-item").forEach(function(n){ n.classList.remove("active"); });
  var nav=document.getElementById("nav-"+id); if(nav) nav.classList.add("active");
  if(id==="timeline"){ setTimeout(initTimeline,50); }
  if(id==="patterns"){ setTimeout(renderPatternList,50); }
}

// â”€â”€ Console é–‹é–‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleConsole(sk){
  var b=document.getElementById("cl-body-"+sk);
  var t=document.getElementById("cl-tog-"+sk);
  if(!b) return;
  var open=b.style.display==="none";
  b.style.display=open?"block":"none";
  if(t) t.textContent=open?"ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹":"ã‚¯ãƒªãƒƒã‚¯ã§å±•é–‹";
}

// â”€â”€ OK/NG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleVerdict(k){
  var saved=lsg(k); var m=META[k]||{};
  var curNG=saved.verdict?saved.verdict==="NG":m.autoNG;
  var nv=curNG?"OK":"NG";
  saved.verdict=nv; lss(k,saved);
  applyVerdict(k,nv);
  updateDashboard(); renderIssueTable();
}
function applyVerdict(k,v){
  var ng=v==="NG";
  var g=function(id){ return document.getElementById(id); };
  var tog=g("vtog-"+k); var lbl=g("vlbl-"+k); var frm=g("iform-"+k);
  var none=g("issue-none-"+k); var al=g("al-"+k); var fbox=g("fbox-"+k);
  var tv=g("tv-"+k); var tc=g("thumb-"+k);
  if(tog) tog.className=ng?"toggle toggle-off":"toggle toggle-on";
  if(lbl){ lbl.textContent=ng?"NG":"OK"; lbl.className=ng?"verdict-text-ng":"verdict-text-ok"; }
  if(frm) frm.classList[ng?"add":"remove"]("open");
  if(none) none.style.display=ng?"none":"block";
  if(al) al.classList[ng?"add":"remove"]("is-ng");
  var ng_html='<span style="color:#dc2626;font-weight:700;">âŒ NG</span>';
  var ok_html='<span style="color:#16a34a;font-weight:700;">âœ… OK</span>';
  if(fbox) fbox.innerHTML=ng?ng_html:ok_html;
  if(tv) tv.innerHTML=ng?ng_html:ok_html;
  if(tc) tc.classList[ng?"add":"remove"]("is-ng");
  var fa=g("farr-"+k);
  if(fa){ var ln=fa.querySelector("line"); var pl=fa.querySelector("polygon"); var c=ng?"#94a3b8":"#16a34a";
    if(ln) ln.setAttribute("stroke",c); if(pl) pl.setAttribute("fill",c); }
  updateScreenBadge(k.split("_seq")[0]);
}
function restoreVerdict(k){
  var saved=lsg(k); var m=META[k]||{};
  applyVerdict(k, saved.verdict||(m.autoNG?"NG":"OK"));
  ["ift","ifp","ifs","ifc","ifm"].forEach(function(pf){
    var el=document.getElementById(pf+"-"+k);
    if(el&&saved[pf]) el.value=saved[pf];
  });
}
function saveIssue(k){
  var saved=lsg(k);
  ["ift","ifp","ifs","ifc","ifm"].forEach(function(pf){
    var el=document.getElementById(pf+"-"+k); if(el) saved[pf]=el.value;
  });
  lss(k,saved); renderIssueTable();
}

// â”€â”€ ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰æ›´æ–° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateDashboard(){
  var ok=0,ng=0,pend=0;
  FIDS.forEach(function(fid){
    var anyNG=false,anyKey=false;
    Object.keys(META).forEach(function(k){
      if(META[k].fid!==fid) return;
      anyKey=true;
      var s=lsg(k); if((s.verdict||(META[k].autoNG?"NG":"OK"))==="NG") anyNG=true;
    });
    if(!anyKey){ pend++; return; }
    if(anyNG) ng++; else pend++;
  });
  var eo=document.getElementById("db-ok"); if(eo) eo.textContent=ok;
  var en=document.getElementById("db-ng"); if(en) en.textContent=ng;
  var ep=document.getElementById("db-pend"); if(ep) ep.textContent=pend;
}
function updateScreenBadge(fid){
  var hasNG=false, cnt=0;
  Object.keys(META).forEach(function(k){
    if(META[k].fid!==fid) return;
    if((lsg(k).verdict||(META[k].autoNG?"NG":"OK"))==="NG"){ hasNG=true; cnt++; }
  });
  var b=document.getElementById("sbadge-"+fid);
  var db=document.getElementById("db-badge-"+fid);
  var nc=document.getElementById("db-ngc-"+fid);
  var cls=hasNG?"badge badge-ng":"badge badge-ok";
  var txt=hasNG?"ğŸ”´ èª²é¡Œã‚ã‚Š":"âœ… ç¢ºèªæ¸ˆ";
  if(b){ b.className=cls; b.textContent=txt; }
  if(db){ db.className=cls; db.textContent=txt; }
  if(nc) nc.textContent=cnt>0?cnt+"ä»¶":"â€”";
}

// â”€â”€ ã‚¹ã‚¯ã‚·ãƒ§ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆDOM API ã‚’ä½¿ç”¨ã€innerHTML+onerror ä¸ä½¿ç”¨ï¼‰â”€â”€
function openSsModal(src,title){
  var m=document.getElementById("ss-modal");
  var t=document.getElementById("modal-title");
  var s=document.getElementById("modal-ss");
  if(!m) return;
  m.style.display="flex";
  if(t) t.textContent=title;
  if(s){
    s.innerHTML="";
    var img=document.createElement("img");
    img.src=src;
    img.style.cssText="max-width:100%;display:block;margin:0 auto;";
    img.onerror=function(){
      s.innerHTML='<div style="padding:32px;color:#94a3b8;text-align:center;">ç”»åƒã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“</div>';
    };
    s.appendChild(img);
  }
}
function closeModal(evt){
  var m=document.getElementById("ss-modal");
  if(!m) return;
  if(!evt||evt.target===m) m.style.display="none";
}

// â”€â”€ ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ­ã‚°ã¸ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function scrollToActionLog(fid,seqNo){
  var el=document.getElementById("al-"+fid+"_seq"+seqNo);
  if(el) el.scrollIntoView({behavior:"smooth",block:"start"});
}

// â”€â”€ èª²é¡Œä¸€è¦§ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderIssueTable(){
  var ft=document.getElementById("iss-filter-type");
  var fs=document.getElementById("iss-filter-status");
  var fp=document.getElementById("iss-filter-prio");
  var ft2=ft?ft.value:""; var fs2=fs?fs.value:""; var fp2=fp?fp.value:"";
  var rows=[];
  Object.keys(META).forEach(function(k){
    var m=META[k]||{}; var s=lsg(k);
    var v=s.verdict||(m.autoNG?"NG":"OK");
    if(v!=="NG") return;
    var ift=s.ift||"ä¸å…·åˆ"; var ifp=s.ifp||"ä¸­"; var ifs=s.ifs||"æœªå¯¾å¿œ";
    if(ft2&&ift!==ft2) return;
    if(fs2&&ifs!==fs2) return;
    if(fp2&&ifp!==fp2) return;
    rows.push({k,fid:m.fid,seqNo:m.seqNo,summary:m.summary,ift,ifp,ifs,ifc:s.ifc||"",ifm:s.ifm||""});
  });
  var lbl=document.getElementById("iss-count-lbl"); if(lbl) lbl.textContent=rows.length+"ä»¶";
  var area=document.getElementById("iss-table-area"); if(!area) return;
  if(!rows.length){ area.innerHTML='<div class="card" style="color:#94a3b8;text-align:center;padding:32px;">è©²å½“ãªã—</div>'; return; }
  var pc={"é«˜":0,"ä¸­":1,"ä½":2};
  rows.sort(function(a,b){ return (pc[a.ifp]||1)-(pc[b.ifp]||1); });
  var h='<div class="card"><table class="spec-table"><thead><tr>'+
    '<th>seq</th><th>ç”»é¢</th><th>æ¦‚è¦</th><th>ç¨®åˆ¥</th><th>å„ªå…ˆåº¦</th><th>çŠ¶æ…‹</th><th>å†…å®¹</th><th>å‚™è€ƒ</th></tr></thead><tbody>';
  rows.forEach(function(r){
    var c=r.ifp==="é«˜"?"#dc2626":r.ifp==="ä¸­"?"#d97706":"#16a34a";
    h+='<tr><td>'+r.seqNo+'</td><td style="font-size:11px;">'+escH(r.fid)+'</td>'+
      '<td>'+escH(r.summary.slice(0,30))+'</td><td>'+escH(r.ift)+'</td>'+
      '<td style="color:'+c+';font-weight:700;">'+escH(r.ifp)+'</td>'+
      '<td>'+escH(r.ifs)+'</td><td>'+escH(r.ifc.slice(0,60))+'</td>'+
      '<td style="font-size:11px;color:#64748b;">'+escH(r.ifm)+'</td></tr>';
  });
  area.innerHTML=h+"</tbody></table></div>";
}
document.addEventListener("DOMContentLoaded",renderIssueTable);

// â”€â”€ ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function escH(s){
  return String(s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");
}
function fmtTJ(ts){
  try{ return new Date(ts).toLocaleTimeString("ja-JP",{hour:"2-digit",minute:"2-digit",second:"2-digit"}); }
  catch(e){ return ts||""; }
}

// â”€â”€ ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initTimeline(){
  renderTlFilterBtns();
  renderTlCards();
}
function renderTlFilterBtns(){
  var el=document.getElementById("tl-filter-btns"); if(!el) return;
  el.innerHTML=Object.keys(TL_COLORS).map(function(fid){
    var col=TL_COLORS[fid];
    return '<button onclick="tlFilterFid(\'"+fid+"\')"'+
      ' style="font-size:11px;padding:3px 10px;border-radius:6px;cursor:pointer;'+
      'border:1px solid '+col+';background:white;color:'+col+';"> '+fid.replace("MC_","")+" </button>";
  }).join("");
}
// ãƒªã‚µã‚¤ã‚ºã§å†æç”»ï¼ˆã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³è¡¨ç¤ºä¸­ã®ã¿ï¼‰
var _tlResizeTimer=null;
window.addEventListener("resize",function(){
  if(document.getElementById("timeline")&&
     document.getElementById("timeline").style.display!=="none"){
    clearTimeout(_tlResizeTimer);
    _tlResizeTimer=setTimeout(renderTlCards,150);
  }
});

function tlFilterAll(){ tlVisible=null; renderTlCards(); }
function tlFilterFid(fid){ tlVisible=[fid]; renderTlCards(); }
function renderTlCards(){
  var cont=document.getElementById("tl-serpentine"); if(!cont) return;
  var containerEl=document.getElementById("tl-container");
  var containerW=containerEl ? Math.max(containerEl.offsetWidth-40, 300) : 900;
  var CARD_SLOT=150;
  var TL_COLS=Math.max(2, Math.floor(containerW/CARD_SLOT));
  var data=tlVisible?TL_DATA.filter(function(s){ return tlVisible.indexOf(s.featureId)>=0; }):TL_DATA;
  var lbl=document.getElementById("tl-total-label"); if(lbl) lbl.textContent=data.length+" seq";
  var cards=data.map(function(s,idx){
    var col=TL_COLORS[s.featureId]||"#94a3b8";
    var isSel=tlSelected.indexOf(s.globalSeqNo)>=0;
    var bdr=isSel?
      "border:2px solid #3b82f6;background:#eff6ff;box-shadow:0 0 0 2px #93c5fd;"
      :"border:2px solid "+col+";background:white;";
    var ng=s.autoNG?'<div style="color:#dc2626;font-weight:700;font-size:10px;">âŒ NG</div>':"";
    var eBdg=s.consoleErr?'<span style="background:#fee2e2;color:#b91c1c;border-radius:3px;padding:0 4px;font-size:9px;">'+s.consoleErr+' ERR</span>':"";
    var wBdg=s.consoleWarn?'<span style="background:#fef9c3;color:#854d0e;border-radius:3px;padding:0 4px;font-size:9px;">'+s.consoleWarn+' WRN</span>':"";
    var th=s.thumbPath
      ?'<img src="'+s.thumbPath+'" style="width:100%;height:64px;object-fit:cover;display:block;" onerror="this.style.display=\'none\'">' 
      :'<div style="width:100%;height:64px;background:#e2e8f0;display:flex;align-items:center;justify-content:center;font-size:10px;color:#94a3b8;">No img</div>';
    return '<div class="tl-card" onclick="tlCardClick(event,'+s.globalSeqNo+','+idx+')"'+
      ' style="'+bdr+'border-radius:8px;cursor:pointer;width:120px;flex-shrink:0;overflow:hidden;">'+
      '<div style="background:'+col+';padding:3px 6px;display:flex;justify-content:space-between;">'+
      '  <span style="color:white;font-size:10px;font-weight:700;">seq '+s.globalSeqNo+'</span>'+
      '  <span style="color:white;font-size:9px;opacity:.85;">'+String(s.featureId||"").replace("MC_","").slice(0,8)+'</span>'+
      '</div>'+th+
      '<div style="padding:5px 6px;">'+
      '  <div style="font-size:10px;font-weight:600;color:#334155;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">'+escH(s.summary)+'</div>'+
      '  <div style="font-size:9px;color:#64748b;margin-top:2px;">'+fmtTJ(s.ts)+'</div>'+
      '  <div style="display:flex;gap:3px;margin-top:3px;flex-wrap:wrap;">'+ng+eBdg+wBdg+'</div>'+
      '</div></div>';
  });
  var sep='<div style="display:flex;align-items:center;padding:0 2px;">'+
    '<svg width="14" height="14" viewBox="0 0 16 16">'+
    '<line x1="0" y1="8" x2="10" y2="8" stroke="#cbd5e1" stroke-width="1.5"/>'+
    '<polygon points="8,4 16,8 8,12" fill="#cbd5e1"/></svg></div>';
  var html="";
  for(var r=0; r*TL_COLS<cards.length; r++){
    var chunk=cards.slice(r*TL_COLS, (r+1)*TL_COLS);
    var isRtl=r%2===1;
    var isLast=(r+1)*TL_COLS>=cards.length;
    var rowDir=isRtl?"flex-direction:row-reverse;":"";
    html+='<div style="display:flex;align-items:flex-start;gap:0;flex-wrap:nowrap;'+rowDir+'">'+chunk.join(sep)+'</div>';
    if(!isLast){
      var uStyle=isRtl
        ?"display:flex;justify-content:flex-start;padding-left:28px;height:28px;align-items:flex-end;"
        :"display:flex;justify-content:flex-end;padding-right:28px;height:28px;align-items:flex-end;";
      var lStyle=isRtl
        ?"width:36px;height:28px;border:2px dashed #cbd5e1;border-top:none;border-right:none;border-radius:0 0 0 10px;"
        :"width:36px;height:28px;border:2px dashed #cbd5e1;border-top:none;border-left:none;border-radius:0 0 10px 0;";
      html+='<div style="'+uStyle+'"><div style="'+lStyle+'"></div></div>';
    }
  }
  cont.innerHTML=html;
}
function tlCardClick(evt,gseq,idx){
  var data=tlVisible?TL_DATA.filter(function(s){return tlVisible.indexOf(s.featureId)>=0;}):TL_DATA;
  if(evt.shiftKey&&tlLastIdx>=0){
    var fr=Math.min(tlLastIdx,idx),to=Math.max(tlLastIdx,idx);
    for(var i=fr;i<=to;i++){ var g=data[i].globalSeqNo; if(tlSelected.indexOf(g)<0) tlSelected.push(g); }
  } else if(evt.ctrlKey||evt.metaKey){
    var pos=tlSelected.indexOf(gseq);
    if(pos>=0) tlSelected.splice(pos,1); else tlSelected.push(gseq);
    tlLastIdx=idx;
  } else { tlSelected=[gseq]; tlLastIdx=idx; }
  renderTlCards(); updateSelPanel();
}
function clearTlSelection(){ tlSelected=[]; tlLastIdx=-1; renderTlCards(); updateSelPanel(); }
function updateSelPanel(){
  var panel=document.getElementById("tl-selection-panel");
  var cnt=document.getElementById("tl-sel-count");
  var sum=document.getElementById("tl-sel-summary");
  var list=document.getElementById("tl-sel-list");
  if(tlSelected.length===0){ if(panel) panel.style.display="none"; return; }
  if(panel) panel.style.display="block";
  var sel=TL_DATA.filter(function(s){return tlSelected.indexOf(s.globalSeqNo)>=0;});
  sel.sort(function(a,b){return a.globalSeqNo-b.globalSeqNo;});
  var uFids=[]; sel.forEach(function(s){ if(uFids.indexOf(s.featureId)<0) uFids.push(s.featureId); });
  if(cnt) cnt.textContent=sel.length;
  if(sum) sum.textContent="seq "+sel[0].globalSeqNo+" ï½ "+sel[sel.length-1].globalSeqNo+
    " | "+uFids.map(function(f){return f.replace("MC_","");}).join(", ");
  if(list) list.innerHTML=sel.map(function(s){
    var col=TL_COLORS[s.featureId]||"#94a3b8";
    return '<div style="background:white;border:1px solid '+col+';border-radius:6px;padding:4px 8px;font-size:11px;">'+
      '<span style="color:'+col+';font-weight:700;">seq '+s.globalSeqNo+'</span> '+
      escH(s.featureId.replace("MC_",""))+" â€” "+escH(s.summary.slice(0,20))+"</div>";
  }).join("");
}

// â”€â”€ ä½œæ¥­ãƒ‘ã‚¿ãƒ¼ãƒ³ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var WPT_KEY="wpt_v31";
function loadPatterns(){ try{return JSON.parse(localStorage.getItem(WPT_KEY))||[];}catch(e){return [];} }
function savePatterns(p){ try{localStorage.setItem(WPT_KEY,JSON.stringify(p));}catch(e){} }
function genPatternId(){ return "WP-"+Date.now()+"-"+Math.random().toString(36).slice(2,6).toUpperCase(); }

function openPatternModal(editId){
  var modal=document.getElementById("wpt-modal"); if(!modal) return;
  modal.style.display="flex";
  if(editId){
    modal.dataset.editId=editId;
    var p=loadPatterns().find(function(x){return x.id===editId;}); if(!p) return;
    document.getElementById("wpt-name").value=p.name||"";
    document.getElementById("wpt-desc").value=p.description||"";
    document.getElementById("wpt-mode").value=p.screenMode||"";
    document.getElementById("wpt-status").value=p.overallStatus||"æœªè©•ä¾¡";
    document.getElementById("wpt-ng-content").value=p.ngContent||"";
    document.getElementById("wpt-ng-priority").value=p.ngPriority||"ä¸­";
    toggleNgArea();
    renderModalSeqList(p.seqs||[]);
  } else {
    delete modal.dataset.editId;
    document.getElementById("wpt-name").value="";
    document.getElementById("wpt-desc").value="";
    document.getElementById("wpt-mode").value="";
    document.getElementById("wpt-status").value="æœªè©•ä¾¡";
    document.getElementById("wpt-ng-content").value="";
    document.getElementById("wpt-ng-priority").value="ä¸­";
    toggleNgArea();
    var seqs=TL_DATA.filter(function(s){return tlSelected.indexOf(s.globalSeqNo)>=0;});
    seqs.sort(function(a,b){return a.globalSeqNo-b.globalSeqNo;});
    renderModalSeqList(seqs);
  }
}
function closePatternModal(){ var m=document.getElementById("wpt-modal"); if(m) m.style.display="none"; }
function toggleNgArea(){
  var st=document.getElementById("wpt-status");
  var ar=document.getElementById("wpt-ng-area");
  if(st&&ar) ar.style.display=st.value==="NG"?"block":"none";
}
function renderModalSeqList(seqs){
  var cnt=document.getElementById("wpt-modal-seqcnt"); if(cnt) cnt.textContent=seqs.length;
  var lst=document.getElementById("wpt-modal-seqlist"); if(!lst) return;
  if(!seqs.length){ lst.innerHTML='<span style="color:#94a3b8;font-size:12px;">æœªé¸æŠ</span>'; return; }
  lst.innerHTML=seqs.map(function(s){
    var col=TL_COLORS[s.featureId]||"#94a3b8";
    return '<div style="background:white;border:1px solid '+col+';border-radius:5px;padding:3px 7px;font-size:11px;">'+
      '<span style="color:'+col+';font-weight:700;">seq '+(s.globalSeqNo||s.seqNo)+'</span> '+
      String(s.featureId||"").replace("MC_","")+" â€” "+escH(String(s.summary||"").slice(0,18))+"</div>";
  }).join("");
}
function savePattern(){
  var name=document.getElementById("wpt-name").value.trim();
  var status=document.getElementById("wpt-status").value;
  if(!name){ alert("ãƒ‘ã‚¿ãƒ¼ãƒ³åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"); return; }
  if(status==="NG"&&!document.getElementById("wpt-ng-content").value.trim()){
    alert("NG ã®å ´åˆã¯ NGå†…å®¹ ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"); return;
  }
  var modal=document.getElementById("wpt-modal");
  var editId=modal.dataset.editId||"";
  var seqData=editId
    ?(loadPatterns().find(function(x){return x.id===editId;})||{}).seqs||[]
    :TL_DATA.filter(function(s){return tlSelected.indexOf(s.globalSeqNo)>=0;}).sort(function(a,b){return a.globalSeqNo-b.globalSeqNo;});
  var pats=loadPatterns();
  var pat={
    id:editId||genPatternId(),
    name:name,
    description:document.getElementById("wpt-desc").value.trim(),
    screenMode:document.getElementById("wpt-mode").value,
    overallStatus:status,
    ngContent:document.getElementById("wpt-ng-content").value.trim(),
    ngPriority:document.getElementById("wpt-ng-priority").value,
    seqs:seqData,
    updatedAt:new Date().toISOString(),
    createdAt:editId?(pats.find(function(x){return x.id===editId;})||{}).createdAt||new Date().toISOString():new Date().toISOString()
  };
  if(editId){ var idx=pats.findIndex(function(x){return x.id===editId;}); if(idx>=0) pats[idx]=pat; else pats.push(pat); }
  else pats.push(pat);
  savePatterns(pats);
  closePatternModal();
  clearTlSelection();
  showPage("patterns");
  renderPatternList();
}
function renderPatternList(){
  var pats=loadPatterns();
  var area=document.getElementById("pattern-list-area"); if(!area) return;
  var ok=pats.filter(function(p){return p.overallStatus==="OK";}).length;
  var ng=pats.filter(function(p){return p.overallStatus==="NG";}).length;
  var pe=pats.filter(function(p){return p.overallStatus!=="OK"&&p.overallStatus!=="NG";}).length;
  var tt=document.getElementById("wpt-total"); if(tt) tt.textContent=pats.length;
  var wok=document.getElementById("wpt-ok");  if(wok) wok.textContent=ok;
  var wng=document.getElementById("wpt-ng");  if(wng) wng.textContent=ng;
  var wpe=document.getElementById("wpt-pend");if(wpe) wpe.textContent=pe;
  if(!pats.length){ area.innerHTML='<div class="card" style="color:#94a3b8;padding:32px;text-align:center;">æœªç™»éŒ²</div>'; return; }
  area.innerHTML=pats.map(function(p){
    var stI=p.overallStatus==="OK"?"âœ…":p.overallStatus==="NG"?"âŒ":"â¬œ";
    var stC=p.overallStatus==="OK"?"#16a34a":p.overallStatus==="NG"?"#dc2626":"#94a3b8";
    var stB=p.overallStatus==="OK"?"#f0fdf4":p.overallStatus==="NG"?"#fff5f5":"#f8fafc";
    var mT=p.screenMode?'<span style="background:#eff6ff;border:1px solid #bfdbfe;color:#1d4ed8;border-radius:4px;padding:1px 7px;font-size:10px;">'+escH(p.screenMode)+"</span>":"";
    var ngS=(p.overallStatus==="NG"&&p.ngContent)
      ?'<div style="background:#fff5f5;border:1px solid #fecaca;border-radius:6px;padding:10px;margin-top:8px;font-size:12px;color:#991b1b;">'+
        '<b>NGå†…å®¹: </b>'+escH(p.ngContent)+
        (p.ngPriority?'<span style="background:#fecaca;border-radius:3px;padding:1px 5px;font-size:10px;margin-left:6px;">å„ªå…ˆåº¦ï¼š'+escH(p.ngPriority)+"</span>":"")+
        "</div>":"";
    var fds=[]; (p.seqs||[]).forEach(function(s){if(s.featureId&&fds.indexOf(s.featureId)<0)fds.push(s.featureId);});
    var fT=fds.map(function(f){var c=TL_COLORS[f]||"#94a3b8"; return '<span style="background:'+c+'22;border:1px solid '+c+';color:'+c+';border-radius:4px;padding:1px 6px;font-size:10px;">'+escH(f.replace("MC_",""))+"</span>";}).join(" ");
    var sL=(p.seqs||[]).map(function(s){var c=TL_COLORS[s.featureId]||"#94a3b8"; return '<span style="background:white;border:1px solid '+c+';border-radius:4px;padding:1px 7px;font-size:10px;">seq '+(s.globalSeqNo||s.seqNo)+"</span>";}).join(" ");
    var upd=p.updatedAt?new Date(p.updatedAt).toLocaleString("ja-JP",{dateStyle:"short",timeStyle:"short"}):"";
    return '<div class="card" style="margin-bottom:14px;border-left:4px solid '+stC+';background:'+stB+';">'+
      '<div style="display:flex;align-items:flex-start;gap:12px;">'+
      '  <div style="flex:1;">'+
      '    <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">'+
      '      <span style="font-size:15px;font-weight:700;color:#0f172a;">'+stI+" "+escH(p.name)+"</span>"+mT+
      '    </div>'+
      (p.description?'<p style="font-size:13px;color:#475569;margin:0 0 6px;">'+escH(p.description)+"</p>":"")+
      '    <div style="display:flex;gap:8px;flex-wrap:wrap;">'+fT+
      '      <span style="font-size:11px;color:#64748b;">'+((p.seqs||[]).length)+' seq</span>'+
      '      <span style="font-size:10px;color:#94a3b8;">'+escH(upd)+"</span>"+
      '    </div>'+
      (sL?'<div style="margin-top:8px;display:flex;gap:4px;flex-wrap:wrap;">'+sL+"</div>":"")+
      ngS+
      '  </div>'+
      '  <div style="display:flex;gap:8px;flex-shrink:0;">'+
      '    <button onclick="openPatternModal(\'"+p.id+"\')"'+
      '      style="font-size:11px;padding:4px 12px;border-radius:6px;border:1px solid #94a3b8;background:white;cursor:pointer;">âœï¸ ç·¨é›†</button>'+
      '    <button onclick="deletePattern(\'"+p.id+"\')"'+
      '      style="font-size:11px;padding:4px 12px;border-radius:6px;border:1px solid #fecaca;background:#fff5f5;color:#dc2626;cursor:pointer;">ğŸ—‘ å‰Šé™¤</button>'+
      '  </div>'+
      '</div></div>';
  }).join("");
}
function deletePattern(id){
  if(!confirm("ã“ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
  savePatterns(loadPatterns().filter(function(p){return p.id!==id;}));
  renderPatternList();
}
</script>
</body>
</html>