<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>èª²é¡Œç®¡ç†ãƒ†ãƒ¼ãƒ–ãƒ« | generate-review.js æ®‹èª²é¡Œ I-01ã€œI-08</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  body { font-family: 'Segoe UI', 'Hiragino Sans', 'Yu Gothic', sans-serif; }
  .mono { font-family: 'Consolas', 'Courier New', monospace; }
  .status-btn { cursor: pointer; transition: all .15s; }
  .status-btn:hover { opacity: .8; transform: scale(1.05); }
  @media print {
    .no-print { display: none !important; }
    body { background: white; }
  }
</style>
</head>
<body class="bg-slate-100 min-h-screen">

<!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
<div class="bg-gradient-to-r from-slate-900 to-slate-700 text-white px-6 py-5">
  <div class="max-w-7xl mx-auto flex items-center justify-between flex-wrap gap-3">
    <div>
      <div class="flex items-center gap-3">
        <span class="text-2xl">ğŸ›</span>
        <div>
          <h1 class="text-xl font-bold">èª²é¡Œç®¡ç†ãƒ†ãƒ¼ãƒ–ãƒ«</h1>
          <p class="text-slate-400 text-xs mt-0.5">generate-review.js æ®‹èª²é¡Œ I-01ã€œI-08 ï¼ ä¼šè©±Fï¼šãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒã‚°ä¿®æ­£ã¨å„ªå…ˆé †ä½ã®ç¢ºèª</p>
        </div>
      </div>
    </div>
    <div class="flex gap-3 no-print">
      <button onclick="window.print()" class="bg-slate-600 hover:bg-slate-500 text-white text-sm px-4 py-2 rounded-lg transition">ğŸ–¨ å°åˆ·</button>
      <button onclick="exportCSV()" class="bg-blue-600 hover:bg-blue-500 text-white text-sm px-4 py-2 rounded-lg transition">ğŸ“¥ CSVå‡ºåŠ›</button>
    </div>
  </div>
</div>

<!-- ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰ -->
<div class="max-w-7xl mx-auto px-4 mt-6">
  <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-5">
    <div class="bg-white rounded-xl p-4 shadow-sm border border-slate-100">
      <div class="text-2xl font-bold text-slate-800" id="cnt-total">8</div>
      <div class="text-xs text-slate-500 mt-1">å…¨èª²é¡Œæ•°</div>
    </div>
    <div class="bg-red-50 rounded-xl p-4 shadow-sm border border-red-100">
      <div class="text-2xl font-bold text-red-600" id="cnt-high">0</div>
      <div class="text-xs text-red-500 mt-1">ğŸ”´ é«˜ å„ªå…ˆåº¦</div>
    </div>
    <div class="bg-yellow-50 rounded-xl p-4 shadow-sm border border-yellow-100">
      <div class="text-2xl font-bold text-yellow-600" id="cnt-med">0</div>
      <div class="text-xs text-yellow-600 mt-1">ğŸŸ¡ ä¸­ å„ªå…ˆåº¦</div>
    </div>
    <div class="bg-green-50 rounded-xl p-4 shadow-sm border border-green-100">
      <div class="text-2xl font-bold text-green-600" id="cnt-done">0</div>
      <div class="text-xs text-green-600 mt-1">âœ… å¯¾å¿œæ¸ˆ</div>
    </div>
  </div>

  <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
  <div class="bg-white rounded-xl shadow-sm border border-slate-100 px-4 py-3 mb-4 flex flex-wrap gap-3 items-center no-print">
    <span class="text-sm font-semibold text-slate-600">ğŸ” ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼š</span>
    <select id="f-priority" onchange="applyFilter()" class="text-sm border border-slate-200 rounded-lg px-3 py-1.5 bg-white">
      <option value="">å„ªå…ˆåº¦: ã™ã¹ã¦</option>
      <option value="é«˜">ğŸ”´ é«˜</option>
      <option value="ä¸­">ğŸŸ¡ ä¸­</option>
      <option value="ä½">ğŸŸ¢ ä½</option>
    </select>
    <select id="f-status" onchange="applyFilter()" class="text-sm border border-slate-200 rounded-lg px-3 py-1.5 bg-white">
      <option value="">çŠ¶æ…‹: ã™ã¹ã¦</option>
      <option value="æœªå¯¾å¿œ">æœªå¯¾å¿œ</option>
      <option value="å¯¾å¿œä¸­">å¯¾å¿œä¸­</option>
      <option value="ãƒ‘ãƒƒãƒã‚ã‚Š">ãƒ‘ãƒƒãƒã‚ã‚Š</option>
      <option value="å®Œäº†">å®Œäº†</option>
    </select>
    <select id="f-category" onchange="applyFilter()" class="text-sm border border-slate-200 rounded-lg px-3 py-1.5 bg-white">
      <option value="">ã‚«ãƒ†ã‚´ãƒª: ã™ã¹ã¦</option>
      <option value="ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³">ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³</option>
      <option value="ä½œæ¥­ãƒ‘ã‚¿ãƒ¼ãƒ³">ä½œæ¥­ãƒ‘ã‚¿ãƒ¼ãƒ³</option>
      <option value="ç”»é¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼">ç”»é¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</option>
      <option value="ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°">ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°</option>
      <option value="èª²é¡Œä¸€è¦§">èª²é¡Œä¸€è¦§</option>
      <option value="ãƒ‡ãƒ¼ã‚¿ä¿å­˜">ãƒ‡ãƒ¼ã‚¿ä¿å­˜</option>
    </select>
    <button onclick="resetFilter()" class="text-sm text-slate-500 hover:text-slate-700 border border-slate-200 rounded-lg px-3 py-1.5 bg-white transition">ãƒªã‚»ãƒƒãƒˆ</button>
    <span id="filter-result" class="text-xs text-slate-400 ml-auto"></span>
  </div>

  <!-- ãƒ†ãƒ¼ãƒ–ãƒ« -->
  <div class="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden mb-8">
    <div class="overflow-x-auto">
      <table class="w-full text-sm" id="main-table">
        <thead>
          <tr class="bg-slate-50 border-b border-slate-200 text-xs text-slate-500 uppercase tracking-wide">
            <th class="px-4 py-3 text-left w-16">ID</th>
            <th class="px-4 py-3 text-left w-24">å„ªå…ˆåº¦</th>
            <th class="px-4 py-3 text-left w-28">ã‚«ãƒ†ã‚´ãƒª</th>
            <th class="px-4 py-3 text-left">èª²é¡Œã‚¿ã‚¤ãƒˆãƒ«</th>
            <th class="px-4 py-3 text-left w-44">å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ« / é–¢æ•°</th>
            <th class="px-4 py-3 text-left w-28">çŠ¶æ…‹</th>
            <th class="px-4 py-3 text-center w-20 no-print">è©³ç´°</th>
          </tr>
        </thead>
        <tbody id="table-body">
          <!-- JS ã§æç”» -->
        </tbody>
      </table>
    </div>
  </div>

  <p class="text-xs text-slate-400 text-center mb-8">è¡Œã‚’ã‚¯ãƒªãƒƒã‚¯ orã€Œâ–¼ è©³ç´°ã€ãƒœã‚¿ãƒ³ã§è©³ç´°ãƒ»ä¿®æ­£æ–¹é‡ã‚’å±•é–‹ ï¼ çŠ¶æ…‹ãƒãƒƒã‚¸ã‚’ã‚¯ãƒªãƒƒã‚¯ã§æ›´æ–°</p>
</div>

<script>
const issues = [
  {
    id: "I-01",
    category: "ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³",
    title: "TL_COLS ã‚’ã‚¹ã‚¯ãƒªãƒ¼ãƒ³å¹…ã§å‹•çš„è¨ˆç®—",
    detail: "TL_COLS=6 å›ºå®šã®ãŸã‚åºƒã„ç”»é¢ã§å³å´ãŒç©ºãã™ãã‚‹ã€‚container.offsetWidth ã‹ã‚‰è‡ªå‹•è¨ˆç®— + window resize ã§å†æç”»ãŒå¿…è¦ã€‚",
    file: "generate-review.js",
    func: "renderTlCards()",
    fix: "Math.floor(containerW / 150) ã§å‹•çš„è¨ˆç®—ã—ã€window.addEventListener('resize', debounce(re-render, 150)) ã‚’è¿½åŠ ã€‚",
    note: "patch_01b_dynamic_cols.mdï¼ˆã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆ No.32ï¼‰ã«ãƒ‘ãƒƒãƒã‚³ãƒ¼ãƒ‰æ¸ˆã¿ã€‚",
    priority: "é«˜",
    status: "ãƒ‘ãƒƒãƒã‚ã‚Š",
    patch: "patch_01b_dynamic_cols.md",
  },
  {
    id: "I-02",
    category: "ä½œæ¥­ãƒ‘ã‚¿ãƒ¼ãƒ³",
    title: "ç·¨é›†ãƒ»å‰Šé™¤ãƒœã‚¿ãƒ³ãŒåå¿œãªã—",
    detail: "renderPatternList() ãŒç”Ÿæˆã™ã‚‹HTML ã® onclick å±æ€§å†…ã§ãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆã®ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ãŒå£Šã‚Œã¦ãŠã‚Š SyntaxError ãŒç™ºç”Ÿã—ã¦ã„ã‚‹ã€‚",
    file: "generate-review.js",
    func: "renderPatternList() â† renderScript()",
    fix: "onclick=\"openPatternModal(\\\\\\\"â€¦\\\\\\\")\" ã®ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã‚’å»ƒæ­¢ã—ã€data-id å±æ€§ + delegated addEventListener ã«å¤‰æ›´ã™ã‚‹ã€‚",
    note: "I-03 ã¨æ ¹æœ¬åŸå› ãŒåŒä¸€ï¼ˆãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆâ†’ã‚·ãƒ³ã‚°ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆã«å¤‰æ›´ï¼‰ã€‚ã¾ã¨ã‚ã¦ Patch 02 ã§å¯¾å‡¦äºˆå®šã€‚",
    priority: "é«˜",
    status: "æœªå¯¾å¿œ",
    patch: null,
  },
  {
    id: "I-03",
    category: "ç”»é¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼",
    title: "ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒœã‚¿ãƒ³ãŒ SyntaxError ã§å…¨æ»…",
    detail: "tlFilterFid() å‘¼ã³å‡ºã—æ™‚ã®å¼•æ•°æ–‡å­—åˆ—ã«ãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆãŒæ··å…¥ã—ã¦ SyntaxError ãŒç™ºç”Ÿã—ã€ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ“ä½œãŒä¸€åˆ‡åŠ¹ã‹ãªã„ã€‚",
    file: "generate-review.js",
    func: "renderTlFilterBtns() â† renderScript()",
    fix: "onclick=\"tlFilterFid(\\\"â€¦\\\")\" â†’ onclick=\"tlFilterFid('â€¦')\" ã«å¤‰æ›´ã€ã¾ãŸã¯ data-fid å±æ€§ + delegated event listener åŒ–ã€‚",
    note: "I-02 ã¨æ ¹æœ¬åŸå› ãŒåŒä¸€ã€‚Patch 02 ã§ã¾ã¨ã‚ã¦å¯¾å‡¦äºˆå®šã€‚",
    priority: "é«˜",
    status: "æœªå¯¾å¿œ",
    patch: null,
  },
  {
    id: "I-04",
    category: "ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°",
    title: "JS ã‚¨ãƒ©ãƒ¼ãƒ»è­¦å‘ŠãŒ .console.jsonl ã«è¨˜éŒ²ã•ã‚Œãªã„",
    detail: "window.onerror ã¯ /log ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ã—ã‹é€ã£ã¦ã„ãªã„ã€‚adjustFixedList4onLoadImage ReferenceError ãªã©é‡è¦ã‚¨ãƒ©ãƒ¼ãŒ .console.jsonl ã«å±Šã‹ãšã€ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ„ãƒ¼ãƒ«ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚¿ãƒ–ã«è¡¨ç¤ºã•ã‚Œãªã„ã€‚",
    file: "talon_testcase_logger.js",
    func: "_setupConsoleCapture() å†…",
    fix: "_setupConsoleCapture() ã®æœ«å°¾ã« window.onerror ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã‚’è¿½åŠ ã— CONSOLE_SERVERï¼ˆ/consolelogï¼‰ã¸é€ä¿¡ã™ã‚‹ã€‚",
    note: "patch_I04_I05_console_error_capture.mdï¼ˆã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆ No.33ï¼‰ã«å®Ÿè£…ã‚³ãƒ¼ãƒ‰æ¸ˆã¿ã€‚",
    priority: "ä¸­",
    status: "ãƒ‘ãƒƒãƒã‚ã‚Š",
    patch: "patch_I04_I05_console_error_capture.md",
  },
  {
    id: "I-05",
    category: "ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°",
    title: "html2canvas 404 / ãƒªã‚½ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼ãŒè¨˜éŒ²ã•ã‚Œãªã„",
    detail: "ãƒªã‚½ãƒ¼ã‚¹èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ï¼ˆNetwork Errorï¼‰ã¯ console.error ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã§ã¯æ•æ‰ã§ããªã„ã€‚CDN ã® html2canvas ã‚„ç”»åƒã® 404 ãŒå®Œå…¨ã«ç´ é€šã‚Šã—ã¦ã„ã‚‹ã€‚",
    file: "talon_testcase_logger.js",
    func: "_setupConsoleCapture() å†…",
    fix: "window.addEventListener('error', fn, true) ã§ã‚­ãƒ£ãƒ—ãƒãƒ£ãƒ•ã‚§ãƒ¼ã‚ºã®ãƒªã‚½ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼ã‚’æ•æ‰ã— CONSOLE_SERVER ã¸é€ä¿¡ã™ã‚‹ã€‚",
    note: "I-04 ã¨åŒãƒ‘ãƒƒãƒï¼ˆpatch_I04_I05_console_error_capture.mdï¼‰ã«å®Ÿè£…ã‚³ãƒ¼ãƒ‰æ¸ˆã¿ã€‚",
    priority: "ä¸­",
    status: "ãƒ‘ãƒƒãƒã‚ã‚Š",
    patch: "patch_I04_I05_console_error_capture.md",
  },
  {
    id: "I-06",
    category: "èª²é¡Œä¸€è¦§",
    title: "èª²é¡Œä¸€è¦§ã‹ã‚‰å„èª²é¡Œã‚’ç·¨é›†ã§ããªã„",
    detail: "renderIssueTable() ãŒç”Ÿæˆã™ã‚‹ HTML å†…ã«ç·¨é›†ãƒœã‚¿ãƒ³ãƒ»ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒå­˜åœ¨ã—ãªã„ã€‚é–²è¦§ã®ã¿ã§ã€ç¨®åˆ¥ãƒ»å„ªå…ˆåº¦ãƒ»çŠ¶æ…‹ãƒ»å†…å®¹ãƒ»å‚™è€ƒã‚’å¤‰æ›´ã™ã‚‹æ‰‹æ®µãŒãªã„ã€‚",
    file: "generate-review.js",
    func: "renderIssueTable() â† renderScript()",
    fix: "å„è¡Œæœ«ã« âœï¸ ç·¨é›†ãƒœã‚¿ãƒ³ã‚’è¿½åŠ ã—ã€openIssueEdit(key) â†’ èª²é¡Œç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆHTML + JSï¼‰ã‚’å®Ÿè£…ã™ã‚‹ã€‚",
    note: "å„ªå…ˆåº¦ä½ã€‚ä½œæ¥­ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼ˆI-02/I-03ï¼‰ä¿®æ­£å¾Œã«å¯¾å¿œæ¨å¥¨ã€‚",
    priority: "ä½",
    status: "æœªå¯¾å¿œ",
    patch: null,
  },
  {
    id: "I-07",
    category: "ãƒ‡ãƒ¼ã‚¿ä¿å­˜",
    title: "localStorage ã®åˆ¶ç´„ãŒãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ä¼ã‚ã£ã¦ã„ãªã„",
    detail: "ä½œæ¥­ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒ»åˆ¤å®šãƒ‡ãƒ¼ã‚¿ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã® localStorage ã«ä¿å­˜ã•ã‚Œã‚‹ã€‚åˆ¥ PC / åˆ¥ãƒ–ãƒ©ã‚¦ã‚¶ / ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãƒ¢ãƒ¼ãƒ‰ã§ã¯å…±æœ‰ã•ã‚Œãšã€ãƒ‡ãƒ¼ã‚¿ãŒæ¶ˆãˆã‚‹ã€‚ç¾çŠ¶ã¯ä½•ã‚‚æ³¨è¨˜ãŒãªã„ã€‚",
    file: "generate-review.jsï¼ˆUIè¡¨ç¤ºï¼‰",
    func: "renderWorkPatternsPage()",
    fix: "ãƒšãƒ¼ã‚¸ä¸Šéƒ¨ã«ã€Œâš ï¸ ãƒ‡ãƒ¼ã‚¿ã¯ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã«ã®ã¿ä¿å­˜ã•ã‚Œã¾ã™ã€‚åˆ¥ PC ã‚„ä»–ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¨ã¯å…±æœ‰ã•ã‚Œã¾ã›ã‚“ã€‚ã€ã®è­¦å‘ŠãƒãƒŠãƒ¼ã‚’è¿½åŠ ã™ã‚‹ã€‚",
    note: "ã‚³ãƒ¼ãƒ‰é‡å°‘ãƒ»å½±éŸ¿å°ã€‚1è¡Œè¿½è¨˜ã§å®Œäº†ã€‚",
    priority: "ä½",
    status: "æœªå¯¾å¿œ",
    patch: null,
  },
  {
    id: "I-08",
    category: "ä½œæ¥­ãƒ‘ã‚¿ãƒ¼ãƒ³",
    title: "ç”»é¢ãƒ¢ãƒ¼ãƒ‰ã«ã€Œèªè¨¼ã€ã€Œå¸³ç¥¨å‡ºåŠ›ã€ãŒä¸è¶³",
    detail: "ä½œæ¥­ãƒ‘ã‚¿ãƒ¼ãƒ³ç™»éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã€Œç”»é¢ãƒ¢ãƒ¼ãƒ‰ã€select ã« é–²è¦§ / ç·¨é›† / æ–°è¦ / æ··åœ¨ / ãã®ä»– ã—ã‹ãªã„ã€‚èªè¨¼ç”»é¢ãƒ»å¸³ç¥¨å‡ºåŠ›ç”»é¢ã«å¯¾å¿œã™ã‚‹ãƒ¢ãƒ¼ãƒ‰ãŒãªãã€æ­£ç¢ºãªåˆ†é¡ãŒã§ããªã„ã€‚",
    file: "generate-review.js",
    func: "renderWorkPatternsPage() ã® option è¦ç´ ",
    fix: "<option value=\"èªè¨¼\">ğŸ” èªè¨¼</option> ã¨ <option value=\"å¸³ç¥¨å‡ºåŠ›\">ğŸ–¨ å¸³ç¥¨å‡ºåŠ›</option> ã‚’ select è¦ç´ ã«è¿½åŠ ã™ã‚‹ã€‚",
    note: "ã‚³ãƒ¼ãƒ‰é‡å°‘ãƒ»1è¡Œè¿½è¨˜ã§å®Œäº†ã€‚",
    priority: "ä½",
    status: "æœªå¯¾å¿œ",
    patch: null,
  },
];

// ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ä¿å­˜ï¼ˆsessionStorage ã§ç°¡æ˜“ç®¡ç†ï¼‰
const STATUS_KEY = 'issue_statuses';
function loadStatuses() {
  try { return JSON.parse(sessionStorage.getItem(STATUS_KEY)) || {}; } catch { return {}; }
}
function saveStatuses(obj) {
  try { sessionStorage.setItem(STATUS_KEY, JSON.stringify(obj)); } catch {}
}

const STATUSES = ['æœªå¯¾å¿œ', 'ãƒ‘ãƒƒãƒã‚ã‚Š', 'å¯¾å¿œä¸­', 'å®Œäº†'];

function statusBadge(st) {
  const map = {
    'æœªå¯¾å¿œ':   'bg-red-100 text-red-700 border border-red-200',
    'ãƒ‘ãƒƒãƒã‚ã‚Š':'bg-blue-100 text-blue-700 border border-blue-200',
    'å¯¾å¿œä¸­':   'bg-yellow-100 text-yellow-700 border border-yellow-200',
    'å®Œäº†':     'bg-green-100 text-green-700 border border-green-200',
  };
  return map[st] || 'bg-slate-100 text-slate-600';
}

function priorityBadge(p) {
  if (p === 'é«˜') return 'bg-red-100 text-red-700 border border-red-200';
  if (p === 'ä¸­') return 'bg-yellow-100 text-yellow-700 border border-yellow-200';
  return 'bg-green-100 text-green-700 border border-green-200';
}

function priorityIcon(p) {
  if (p === 'é«˜') return 'ğŸ”´';
  if (p === 'ä¸­') return 'ğŸŸ¡';
  return 'ğŸŸ¢';
}

function categoryIcon(c) {
  const m = { 'ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³':'â±', 'ä½œæ¥­ãƒ‘ã‚¿ãƒ¼ãƒ³':'ğŸ“‹', 'ç”»é¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼':'ğŸ”', 'ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°':'ğŸ“Ÿ', 'èª²é¡Œä¸€è¦§':'ğŸ“‘', 'ãƒ‡ãƒ¼ã‚¿ä¿å­˜':'ğŸ’¾' };
  return m[c] || 'ğŸ“Œ';
}

function cycleStatus(id) {
  const statuses = loadStatuses();
  const issue = issues.find(i => i.id === id);
  const cur = statuses[id] || issue.status;
  const idx = STATUSES.indexOf(cur);
  const next = STATUSES[(idx + 1) % STATUSES.length];
  statuses[id] = next;
  saveStatuses(statuses);
  render();
  updateSummary();
}

function toggleDetail(id) {
  const row = document.getElementById('detail-' + id);
  if (!row) return;
  const isOpen = row.style.display === 'table-row';
  row.style.display = isOpen ? 'none' : 'table-row';
  const btn = document.getElementById('toggle-btn-' + id);
  if (btn) btn.textContent = isOpen ? 'â–¼ è©³ç´°' : 'â–² é–‰ã˜ã‚‹';
}

function applyFilter() {
  const fp = document.getElementById('f-priority').value;
  const fs = document.getElementById('f-status').value;
  const fc = document.getElementById('f-category').value;
  const statuses = loadStatuses();

  let shown = 0;
  issues.forEach(issue => {
    const curStatus = statuses[issue.id] || issue.status;
    const row = document.getElementById('row-' + issue.id);
    const det = document.getElementById('detail-' + issue.id);
    if (!row) return;
    const match =
      (!fp || issue.priority === fp) &&
      (!fs || curStatus === fs) &&
      (!fc || issue.category === fc);
    row.style.display = match ? '' : 'none';
    if (det) det.style.display = 'none';
    if (match) shown++;
  });

  document.getElementById('filter-result').textContent = `${shown} ä»¶è¡¨ç¤ºä¸­`;
}

function resetFilter() {
  document.getElementById('f-priority').value = '';
  document.getElementById('f-status').value = '';
  document.getElementById('f-category').value = '';
  applyFilter();
}

function updateSummary() {
  const statuses = loadStatuses();
  let high = 0, med = 0, done = 0;
  issues.forEach(i => {
    if (i.priority === 'é«˜') high++;
    if (i.priority === 'ä¸­') med++;
    const s = statuses[i.id] || i.status;
    if (s === 'å®Œäº†') done++;
  });
  document.getElementById('cnt-high').textContent = high;
  document.getElementById('cnt-med').textContent = med;
  document.getElementById('cnt-done').textContent = done;
}

function render() {
  const statuses = loadStatuses();
  const tbody = document.getElementById('table-body');
  tbody.innerHTML = '';

  issues.forEach(issue => {
    const curStatus = statuses[issue.id] || issue.status;

    // ãƒ¡ã‚¤ãƒ³è¡Œ
    const tr = document.createElement('tr');
    tr.id = 'row-' + issue.id;
    tr.className = 'border-b border-slate-100 hover:bg-slate-50 cursor-pointer transition-colors';
    tr.onclick = (e) => {
      if (e.target.closest('.status-btn') || e.target.closest('.no-click')) return;
      toggleDetail(issue.id);
    };

    tr.innerHTML = `
      <td class="px-4 py-3">
        <span class="mono font-bold text-slate-700 text-sm">${issue.id}</span>
      </td>
      <td class="px-4 py-3">
        <span class="inline-flex items-center gap-1 text-xs font-semibold px-2.5 py-1 rounded-full ${priorityBadge(issue.priority)}">
          ${priorityIcon(issue.priority)} ${issue.priority}
        </span>
      </td>
      <td class="px-4 py-3">
        <span class="text-xs text-slate-600">${categoryIcon(issue.category)} ${issue.category}</span>
      </td>
      <td class="px-4 py-3">
        <p class="text-sm font-semibold text-slate-800 leading-snug">${issue.title}</p>
        <p class="text-xs text-slate-500 mt-0.5 line-clamp-1">${issue.detail.slice(0, 60)}â€¦</p>
      </td>
      <td class="px-4 py-3">
        <p class="mono text-xs text-blue-700 font-semibold">${issue.file}</p>
        <p class="mono text-xs text-slate-400 mt-0.5">${issue.func}</p>
      </td>
      <td class="px-4 py-3 no-click">
        <button class="status-btn inline-flex items-center text-xs font-semibold px-2.5 py-1 rounded-full ${statusBadge(curStatus)}"
                onclick="event.stopPropagation(); cycleStatus('${issue.id}')"
                title="ã‚¯ãƒªãƒƒã‚¯ã§æ¬¡ã®çŠ¶æ…‹ã¸">
          ${curStatus} â†»
        </button>
      </td>
      <td class="px-4 py-3 text-center no-print">
        <button id="toggle-btn-${issue.id}"
                class="text-xs text-slate-400 hover:text-blue-600 border border-slate-200 rounded-lg px-2 py-1 transition"
                onclick="event.stopPropagation(); toggleDetail('${issue.id}')">â–¼ è©³ç´°</button>
      </td>
    `;
    tbody.appendChild(tr);

    // è©³ç´°è¡Œ
    const det = document.createElement('tr');
    det.id = 'detail-' + issue.id;
    det.style.display = 'none';
    det.className = 'bg-indigo-50/40 border-b-2 border-indigo-100';

    det.innerHTML = `
      <td colspan="7" class="px-6 py-5">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-5">

          <!-- èª²é¡Œè©³ç´° -->
          <div class="space-y-3">
            <p class="text-xs font-bold text-slate-500 uppercase tracking-wider">ğŸ“‹ èª²é¡Œè©³ç´°</p>
            <div class="bg-white rounded-xl p-4 space-y-2.5 text-xs shadow-sm">
              <div class="flex gap-2">
                <span class="text-slate-400 w-20 shrink-0">èª²é¡ŒID</span>
                <span class="mono font-bold text-slate-700">${issue.id}</span>
              </div>
              <div class="flex gap-2">
                <span class="text-slate-400 w-20 shrink-0">ã‚«ãƒ†ã‚´ãƒª</span>
                <span class="text-slate-700">${categoryIcon(issue.category)} ${issue.category}</span>
              </div>
              <div class="flex gap-2">
                <span class="text-slate-400 w-20 shrink-0">å„ªå…ˆåº¦</span>
                <span class="font-semibold">${priorityIcon(issue.priority)} ${issue.priority}</span>
              </div>
              <div class="flex gap-2">
                <span class="text-slate-400 w-20 shrink-0">å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«</span>
                <span class="mono text-blue-700 font-semibold">${issue.file}</span>
              </div>
              <div class="flex gap-2">
                <span class="text-slate-400 w-20 shrink-0">å¯¾è±¡é–¢æ•°</span>
                <span class="mono text-slate-600 text-xs">${issue.func}</span>
              </div>
              ${issue.patch ? `
              <div class="flex gap-2">
                <span class="text-slate-400 w-20 shrink-0">ãƒ‘ãƒƒãƒè³‡æ–™</span>
                <span class="text-green-700 font-semibold">ğŸ“„ ${issue.patch}</span>
              </div>` : ''}
            </div>
          </div>

          <!-- ç—‡çŠ¶ãƒ»ä¿®æ­£æ–¹é‡ -->
          <div class="space-y-3">
            <p class="text-xs font-bold text-slate-500 uppercase tracking-wider">ğŸ” ç—‡çŠ¶ãƒ»è©³ç´°</p>
            <div class="bg-white rounded-xl p-4 text-xs text-slate-700 leading-relaxed shadow-sm">
              ${issue.detail}
            </div>
            <p class="text-xs font-bold text-slate-500 uppercase tracking-wider">ğŸ”§ ä¿®æ­£æ–¹é‡</p>
            <div class="bg-emerald-50 border border-emerald-200 rounded-xl p-4 text-xs text-emerald-800 leading-relaxed shadow-sm">
              ${issue.fix}
            </div>
          </div>

          <!-- å‚™è€ƒãƒ»çŠ¶æ…‹å¤‰æ›´ -->
          <div class="space-y-3">
            <p class="text-xs font-bold text-slate-500 uppercase tracking-wider">ğŸ“ å‚™è€ƒãƒ»ãƒ¡ãƒ¢</p>
            <div class="bg-white rounded-xl p-4 text-xs text-slate-600 leading-relaxed shadow-sm">
              ${issue.note}
            </div>
            <p class="text-xs font-bold text-slate-500 uppercase tracking-wider">ğŸ”„ çŠ¶æ…‹ã‚’å¤‰æ›´</p>
            <div class="bg-white rounded-xl p-4 shadow-sm flex flex-wrap gap-2">
              ${STATUSES.map(s => `
                <button onclick="event.stopPropagation(); forceStatus('${issue.id}','${s}')"
                  class="text-xs px-3 py-1.5 rounded-full border font-semibold transition hover:opacity-80 ${statusBadge(s)} ${(statuses[issue.id] || issue.status) === s ? 'ring-2 ring-offset-1 ring-blue-400' : ''}">
                  ${s}
                </button>
              `).join('')}
            </div>
          </div>

        </div>
      </td>
    `;
    tbody.appendChild(det);
  });

  applyFilter();
  updateSummary();
}

function forceStatus(id, status) {
  const statuses = loadStatuses();
  statuses[id] = status;
  saveStatuses(statuses);
  render();
}

function exportCSV() {
  const statuses = loadStatuses();
  const header = ['ID', 'å„ªå…ˆåº¦', 'ã‚«ãƒ†ã‚´ãƒª', 'ã‚¿ã‚¤ãƒˆãƒ«', 'å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«', 'å¯¾è±¡é–¢æ•°', 'çŠ¶æ…‹', 'ãƒ‘ãƒƒãƒè³‡æ–™'];
  const rows = issues.map(i => [
    i.id, i.priority, i.category, i.title, i.file, i.func,
    statuses[i.id] || i.status,
    i.patch || ''
  ]);
  const csv = [header, ...rows].map(r => r.map(c => `"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'issues_table.csv';
  a.click();
}

render();
</script>
</body>
</html>
