# .github/workflows/generate-review.yml
# ============================================================
# ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ¬ãƒ“ãƒ¥ãƒ¼HTML è‡ªå‹•ç”Ÿæˆãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
#
# [v3.1 ä¿®æ­£]
#   â‘  workflow_run ã® workflows åã‚’å®Ÿéš›ã®åå‰ã«ä¿®æ­£
#      å¤‰æ›´å‰: ['å•é¡Œãƒ»èª²é¡Œ è‡ªå‹•è§£æ']  â† ä¸ä¸€è‡´ã§é€£é–èµ·å‹•ã—ãªã‹ã£ãŸ
#      å¤‰æ›´å¾Œ: ['Analyze Issues & Publish Dashboard']
#   â‘¡ push ãƒˆãƒªã‚¬ãƒ¼ã‚’è¿½åŠ 
#      logs/features/*.jsonl ã¾ãŸã¯ logs/screenshots/** ã« Push ã•ã‚ŒãŸ
#      æ™‚ç‚¹ã§ç›´æ¥èµ·å‹•ï¼ˆanalyze-issues ã‚’çµŒç”±ã—ãªã„å ´åˆã«ã‚‚å¯¾å¿œï¼‰
#
# ãƒˆãƒªã‚¬ãƒ¼ï¼ˆ3ç³»çµ±ï¼‰:
#   1. push: logs/features/*.jsonl ã¾ãŸã¯ logs/screenshots/** ã®å¤‰æ›´
#   2. workflow_run: analyze-issues.yml å®Œäº†å¾Œã«è‡ªå‹•é€£é–
#   3. workflow_dispatch: Actions ã‚¿ãƒ–ã‹ã‚‰æ‰‹å‹•å®Ÿè¡Œ
#
# å‡¦ç†:
#   1. logs/features/*.jsonl â†’ ã‚·ãƒ¼ã‚±ãƒ³ã‚¹æ§‹ç¯‰
#   2. logs/screenshots/     â†’ ã‚¹ã‚¯ã‚·ãƒ§åé›†ï¼ˆdocs/screenshots/ ã«ã‚³ãƒ”ãƒ¼ï¼‰
#   3. docs/issues/issues.json â†’ èª²é¡Œãƒ‡ãƒ¼ã‚¿ç…§åˆ
#   4. docs/review/index.html â†’ ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ¬ãƒ“ãƒ¥ãƒ¼HTMLç”Ÿæˆ
#   5. docs/ ã‚’è‡ªå‹•ã‚³ãƒŸãƒƒãƒˆ & Push â†’ GitHub Pages ã«åæ˜ 
#
# GitHub Pages URL:
#   https://karkyon.github.io/log-server/review/
# ============================================================

name: ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ¬ãƒ“ãƒ¥ãƒ¼HTMLç”Ÿæˆ

on:
  # â”€â”€ 1. analyze-issues å®Œäº†å¾Œã«ã®ã¿èµ·å‹•ï¼ˆç›´åˆ—åŒ–ï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  workflow_run:
    workflows: ['Analyze Issues & Publish Dashboard']
    types: [completed]
    branches: [main]

  # â”€â”€ 2. ã‚¹ã‚¯ãƒªãƒ—ãƒˆä¿®æ­£æ™‚ã«ã‚‚èµ·å‹• â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  push:
    branches: [main]
    paths:
      - 'scripts/generate-review.js'   # â† ã‚¹ã‚¯ãƒªãƒ—ãƒˆä¿®æ­£ã§èµ·å‹•
      # logs/ ã® push ã¯ analyze-issues çµŒç”±ã§èµ·å‹•ã™ã‚‹ã®ã§ä¸è¦

  # â”€â”€ 3. æ‰‹å‹•å®Ÿè¡Œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  workflow_dispatch:
    inputs:
      reason:
        description: 'å®Ÿè¡Œç†ç”±ï¼ˆä»»æ„ï¼‰'
        required: false
        default: 'æ‰‹å‹•ç”Ÿæˆ'

jobs:
  generate-review:
    # workflow_run ã§å¤±æ•—æ‰±ã„ã®å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
    if: >
      github.event_name != 'workflow_run' ||
      github.event.workflow_run.conclusion == 'success'
    name: ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ¬ãƒ“ãƒ¥ãƒ¼HTMLç”Ÿæˆ
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      # â”€â”€ 1. ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # â”€â”€ 2. Node.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      # â”€â”€ 3. ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Install dependencies
        run: npm ci

      # â”€â”€ 4. ã‚¹ã‚¯ã‚·ãƒ§ã‚’ docs/ ã«ã‚³ãƒ”ãƒ¼ï¼ˆGitHub Pages ã§é…ä¿¡ã™ã‚‹ãŸã‚ï¼‰â”€â”€
      - name: Copy screenshots to docs/
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ã‚¹ã‚¯ã‚·ãƒ§ã‚’ docs/screenshots/ ã«ã‚³ãƒ”ãƒ¼"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          if [ -d "logs/screenshots" ]; then
            mkdir -p docs/screenshots
            cp -r logs/screenshots/. docs/screenshots/
            echo "ã‚³ãƒ”ãƒ¼å®Œäº† â€” ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«æ•°:"
            find docs/screenshots -name "*.jpg" -o -name "*.png" | wc -l
          else
            echo "screenshots ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãªã—ï¼ˆã‚¹ã‚­ãƒƒãƒ—ï¼‰"
          fi

      # â”€â”€ 5. ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ¬ãƒ“ãƒ¥ãƒ¼HTMLç”Ÿæˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Generate review HTML
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ¬ãƒ“ãƒ¥ãƒ¼HTMLç”Ÿæˆ (generate-review.js v3.1)"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          node scripts/generate-review.js

      # â”€â”€ 6. ç”Ÿæˆçµæœã‚µãƒãƒªå‡ºåŠ› â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Print summary
        run: |
          node -e "
            const fs = require('fs');
            const html = fs.readFileSync('docs/review/index.html','utf8');
            const size = (Buffer.byteLength(html,'utf8')/1024).toFixed(1);
            const pageMatches = html.match(/class=\"page\"/g) || [];
            const seqMatches  = html.match(/class=\"action-log\"/g) || [];
            console.log('');
            console.log('ğŸ“‹ ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”Ÿæˆã‚µãƒãƒª');
            console.log('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');
            console.log('ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º :', size + ' KB');
            console.log('ç”»é¢ãƒšãƒ¼ã‚¸æ•°  :', pageMatches.length - 1, 'ï¼ˆèª²é¡Œä¸€è¦§é™¤ãï¼‰');
            console.log('ã‚·ãƒ¼ã‚±ãƒ³ã‚¹æ•°  :', seqMatches.length);
            console.log('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');
            console.log('ğŸ“ URL: https://karkyon.github.io/log-server/review/');
          "

      # â”€â”€ 7. è‡ªå‹•ã‚³ãƒŸãƒƒãƒˆ & Push â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Commit and push
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add docs/

          git diff --cached --quiet && {
            echo "å¤‰æ›´ãªã—ã€‚ã‚³ãƒŸãƒƒãƒˆã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚"
            exit 0
          }

          TRIGGER="${{ github.event_name }}"
          # [skip ci] ã‚’ä»˜ä¸ã—ã¦ã“ã®ã‚³ãƒŸãƒƒãƒˆè‡ªä½“ãŒãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å†èµ·å‹•ã—ãªã„ã‚ˆã†ã«ã™ã‚‹
          MSG="docs: ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ¬ãƒ“ãƒ¥ãƒ¼è‡ªå‹•æ›´æ–° [${TRIGGER}] [skip ci]"
          git commit -m "$MSG"
          git push origin main